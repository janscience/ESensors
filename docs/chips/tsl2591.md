# AMS TSL2591 light-to-digital converter

Ambient [light](../parameters/light/) sensor (ALS) senses

- full spectrum light intensity
- IR light intensity


## Resources

- [AMS Website](https://ams.com)
- [TSL2591 product page](https://ams.com/en/tsl25911)
- [Datasheet](https://ams.com/documents/20143/36005/TSL2591_DS000338_6-00.pdf)
- [Application notes](https://ams.com/en/tsl25911#tab/documents)


## Calibration

The TSL2591 provides two 16-bit readings (`counts`) that cover
different wavelengths:

- `C0DATA`: channel 0, full spectrum, and
- `C1DATA`: channel 1, IR spectrum

![spectral responsivity](https://user-images.githubusercontent.com/181073/48271825-8593e400-e43d-11e8-947f-8950b84dbdd9.png)

To get a
[photometric](https://github.com/janscience/TeeSense/tree/main/docs/parameters/light#units)
measure of light intensity, one would ideally use a sensor that has
the same spectral sensitivity as the human eye. However, silicon photo
diodes have a much wider spectral sensitivity. One commo solution is
to add an optical filter in front of the photodiode. The solution
taken by the TSL2591 is to provide two measurements from the
photodiode, one with the broad spectrum and one with a reduced
spectrum for IR, as shown in the figure.

Knowing the spectrum of the measured light source, the appropriately
weighted IR signal can be subtracted from the full sepctrum signal to
get an estimate of photometric illuminance measured in lux.

In addition, any mechanical and optical settings also influence the amount
and probably the spectral composition of light reaching the sensor.

This implies that the sensor has to calibrated for each specific
application, in order to get an appropriate reading of illuminance.
Unfortunately, there can not be a default calibration that fits all
use cases.


## Irradiance

First, let's put illuminance aside, and just consider how to scale the
raw sensor readings, `C0DATA` and `C1DATA`, to a radiometric measure
of irradiance, i.e. the amount of light energy per time and area.

Scaling raw readings to irradiance also depends on the spectrum of the
light source in relation to the spectral responsivity.  And it
depends, of course, on the integration time and the gain settings of
the TSL2591.

On the
[datasheet](https://ams.com/documents/20143/36005/TSL2591_DS000338_6-00.pdf),
Figure 8, we find, for the example of two different light sources, a
white-light emitting diode and a 850nm GaAs LED (IR light), values for
the irradiance responsitivity *R<sub>e</sub>* in counts per
&micro;W/cm<sup>2</sup>:

| light source | channel0 | channel 1 |
| ------------ | -------- | --------- |
| white light  |    264.1 |      34.9 |
| 850nm        |    257.5 |     154.1 |

These values were measured at high gain (x400) and an integration time
of 100ms. The irradiance *E* is then given by

![irradiancefull](https://latex.codecogs.com/svg.image?\large&space;E&space;=&space;\text{C0DATA}&space;\frac{400&space;\cdot&space;100\,\text{ms}}{R_e&space;g&space;\tau})

where we first multiply the sensor reading `C0DATA` (or `C1DATA`) by
the gain and integration time for which the responsitivity from the
table were obtained, and then divide by the responsitivity
*R<sub>e</sub>* from the table and the actual gain, *g*, and
integration time, &tau;, for which the sensor reading was obtained.
The gain, integration time, and resistivity can be combined into a
single factor *c<sub>R</sub>* and we get

![irradiance](https://latex.codecogs.com/svg.image?\large&space;E&space;=&space;\frac{\text{C0DATA}}{C_R&space;g&space;\tau})

with the following values for *c<sub>R</sub>* in counts per
W/m<sup>2</sup> and ms:

| light source | channel0 | channel 1 |
| ------------ | -------- | --------- |
| white light  |    0.660 |     0.087 |
| 850nm        |    0.644 |     0.385 |

The values used in the
[TSL2591MI](https://bitbucket.org/christandlg/tsl2591mi/) library come
from an older datasheet referenced in this
[issue](https://github.com/adafruit/Adafruit_CircuitPython_TSL2591/issues/7#issuecomment-437404689)
that have been measured with maximum gain (x9876) and also 100ms integration time. The resulting values for *c<sub>R</sub>* are similar, but not identical.

Note that the raw readings only approximately scale with gain and
integration time as expected. The following table shows readings for
the two channels averaged over 100 measurements (obtained with the
[tsl2591gains example](../../examples/tsl2591gains/)). The last two
columns show the ratio relative to the 100ms setting:

| time  | gain | C0DATA | C1DATA | scale0 | scale1 |
| ----- | ---- | ------ | ------ | ------ | ------ |
| 100ms | MED  |  848.0 |  149.5 |   1.00 |   1.00 |
| 200ms | MED  | 1672.7 |  294.7 |   1.97 |   1.97 |
| 300ms | MED  | 2497.4 |  439.8 |   2.95 |   2.94 |
| 400ms | MED  | 3322.9 |  584.9 |   3.92 |   3.91 |
| 500ms | MED  | 4141.8 |  729.2 |   4.88 |   4.88 |
| 600ms | MED  | 4960.6 |  873.2 |   5.85 |   5.84 |

The situation is worse for the gains, they differ between the channels:

| time  | gain | C0DATA  | C1DATA  | scale0  | scale1  |
| ----- | ---- | ------- | ------- | ------- | ------- |
| 200ms | LOW  |    70.0 |    13.0 |    1.00 |    1.00 |
| 200ms | MED  |  1675.0 |   295.4 |   23.93 |   22.72 |
| 200ms | HIGH | 28889.6 |  4975.8 |  412.71 |  382.75 |


## Luminance (lux)

...

The [Adafruit TSL2591
  Library](https://github.com/adafruit/Adafruit_TSL2591_Library) uses
  an equation suggested by this
  [issue](https://github.com/adafruit/Adafruit_TSL2591_Library/issues/14). This
  equation differs in structure from the ones from the datasheet and
  has the additional problem of a possible division by zero.


## Hardware

- [Adafruit TSL2591 High Dynamic Range Digital Light Sensor](https://learn.adafruit.com/adafruit-tsl2591)

  ![pinout](https://cdn-shop.adafruit.com/970x728/1980-07.jpg)

- [BlueDot BME280+TSL2591 Advanced Weather Station](https://www.bluedot.space/products/bme280-tsl2591/)

  ![pinout](https://image.jimcdn.com/app/cms/image/transf/dimension=697x10000:format=png/path/s9044904ce8b43c5c/image/ic78b28bd0a4d9113/version/1525169534/i2c-wiring-for-bme280-tsl2591-board.png)

  

## Library survey

For our purpuse (non blocking acquisition), the following library by
[Gregor Christandl](https://bitbucket.org/christandlg/) is most suitable:

- [TSL2591MI](https://bitbucket.org/christandlg/tsl2591mi/):
  flexible bus interface, enable/disable, power up/down, non-blocking reads, temperature
  compensation, counts, irradiance, brightness conversion, from visual
  or IR channel.


A search via the library manager of the Arduino IDE also results in
(April 2022):

- [Adafruit TSL2591
  Library](https://github.com/adafruit/Adafruit_TSL2591_Library):
  flexible bus interface, blocking reads only.

- [BlueDot TSL2591
  Library](https://github.com/BlueDot-Arduino/BlueDot_BME280_TSL2591):
  fixed interface, blocking reads only.

- [UncleRus ESP-IDF Components
  library](https://github.com/UncleRus/esp-idf-lib): blocking data
  request.
